# 認証フロー問題の修正依頼

## 問題の概要
シークレットウィンドウで1回目はログインできるが、2回目以降ログインできない問題が発生。通常のブラウザでは問題ないが、シークレットウィンドウでの認証状態管理に問題がある。

## 現在の実装
- `frontend/src/state/auth/AuthContext.tsx` - 認証状態管理
- Supabase Auth を使用した認証フロー
- `onAuthStateChange` で認証状態変更を監視
- `isInitializing` で初期化状態を管理

## 技術的課題
1. **認証状態の初期化順序** - `initAuth()` と `onAuthStateChange` の実行タイミング
2. **セッション復元の競合** - 既存セッション取得と認証状態変更の競合
3. **シークレットウィンドウの制約** - セッション管理の特殊性
4. **初期化完了のタイミング** - `isInitializing` の適切な管理

## 期待する修正内容
1. **認証フローの安定化**
   - シークレットウィンドウでも2回目以降のログインが可能
   - 認証状態の初期化が確実に完了
   - セッション復元と認証状態変更の競合を回避

2. **エラーハンドリングの強化**
   - 認証失敗時の適切なフォールバック
   - セッション失効時の処理
   - デバッグログの充実

3. **パフォーマンスの最適化**
   - 不要な認証チェックの削減
   - 初期化時間の短縮

## 対象ファイル
- `frontend/src/state/auth/AuthContext.tsx` - メインの修正対象
- 必要に応じて `frontend/src/pages/Login.tsx` の調整

## 制約事項
- 既存のSupabase Auth実装を維持
- 他の認証機能（ログアウト、セッション更新）に影響しない
- 通常のブラウザでの動作は維持

## 期待する回答形式
1. **修正されたコード** - 具体的な実装
2. **修正理由の説明** - なぜその修正が必要か
3. **テスト方法** - シークレットウィンドウでの検証手順
4. **追加の改善提案** - 認証フローのさらなる改善点
