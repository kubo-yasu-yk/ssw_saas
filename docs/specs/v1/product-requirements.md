# プロダクト要件概要

特定技能在留資格管理システムの現状要件を、リポジトリ内のソースコードとドキュメント（`README.md`、`frontend/src/pages/*` など）をもとに整理したサマリーです。プロトタイプレベルながら、実運用を想定した要件が明文化されています。

## 背景と目的
- 受入機関／登録支援機関が管理する **特定技能外国人の在留資格情報と関連書類を一元管理** する。
- Supabase を用いたバックエンドレス構成で短期間に MVP を構築し、Vercel 上での継続的デリバリーを成立させる。
- 開発・ステージング・本番の 3 段階で安全に運用し、本番データを厳格に保護する。

## 想定利用者
- **管理者（社内担当者）**: ログインして外国人情報や書類を登録・更新する。
- **登録支援機関スタッフ**: 手続き状況を把握し、書類作成・提出を行う。
- **システム管理者**: Supabase プロジェクトや Vercel デプロイを運用し、データ保全とアクセス管理を行う。

## 機能要件

### 認証・ユーザー管理
- Supabase Auth（メール＋パスワード）を利用したログイン／ログアウト。
- 認証済みユーザーのプロフィール情報を `profiles` テーブルと同期し、所属会社（`companyId`）と役割を管理。
- Row Level Security により、認証ユーザーは自社データのみ閲覧・更新できる。

### ダッシュボード
- 申請中／承認済み書類の件数、今月の申請数の KPI を表示。
- 直近更新された書類 5 件と最新の活動ログ 6 件を一覧し、ステータスを即座に把握できる。

### 特定技能外国人管理
- 外国人一覧の表示・検索（氏名／カナ／国籍／旅券番号をキーワード検索）。
- 新規登録ダイアログから、氏名・国籍・在留資格・在留期間など必須項目を入力して作成。
- 既存レコードの更新・削除（`frontend/src/api/foreigners.service.ts`）。

### 書類管理
- 書類一覧で種別・ステータスによるフィルタリング、対象者名の表示。
- 書類作成／編集フォームを種別ごとに用意：
  - 在留資格認定証明書交付申請 (`ResidenceStatusForm.tsx`)
  - 在留期間更新許可申請 (`PeriodExtensionForm.tsx`)
  - 在留資格変更許可申請 (`StatusChangeForm.tsx`)
  - 定期面談報告書 (`InterviewReportForm.tsx`)
  - 随時届出（退職）報告 (`ResignationReportForm.tsx`)
- ステータス更新（ドラフト／申請中／承認済み／却下）。
- PDF 出力（現状は `jspdf`／`html2canvas` ベースのモックトーストで将来機能を想定）。

### 会社情報管理
- 受入機関の基本情報（住所・代表者・連絡先等）の表示・更新 (`CompanyInfoPage.tsx`)。

### アクティビティログ
- 主要操作（書類作成・更新等）を `activity_logs` テーブルに蓄積し、ダッシュボードで最新履歴を提示。

### 共通要件
- すべてのフォームは React Hook Form + Zod でバリデーションを実施。
- UI コンポーネントは shadcn/ui + Radix UI を活用し、一貫性のあるインタラクションを提供。

## データ要件
- **主要テーブル（Supabase/PostgreSQL）**
  - `companies`: 受入機関のマスタ。`profiles.company_id` と `foreigners.company_id` の参照先。
  - `foreigners`: 在留資格対象者。会社と 1:N、書類と 1:N のリレーションを持つ。
  - `documents`: 申請書類のメタデータ。種別・ステータス・対象者 ID・JSON データを保持。
  - `activity_logs`: 監査用ログ。操作内容とタイムスタンプを記録。
  - `profiles`: Supabase Auth ユーザー拡張。役割や所属を格納。
- `supabase/schema.sql` にトリガー `update_updated_at()` を定義し、`updated_at` を自動更新。
- `seed.sql` で開発用初期データ（ユーザー・会社・外国人・書類・ログ）を投入。

## 非機能要件
- **セキュリティ**: 全テーブルで RLS を有効化し、認証ユーザーは `company_id` 単位でアクセス制御する。Anon Key 漏えいリスクに備え、定期的なローテーションを推奨。
- **環境分離**: ローカル／Vercel Preview は開発用 Supabase、本番デプロイは本番 Supabase に接続。`docs/environment-setup.md` で運用手順を定義。
- **デプロイ／CI**: `main` ブランチへの push で Vercel Production が自動デプロイ。Preview はブランチごとに生成され、レビュー・QA に利用。
- **可観測性**: Supabase Table Editor や Activity Log で最低限の追跡性を確保。将来の監査ログ拡張を想定。
- **パフォーマンス**: Vite + React による軽量フロントエンド。Supabase のリアルタイム機能に拡張余地あり。

## 今後の検討事項
- PDF 出力の実装（`handleExportPdf` は現状モック）。帳票テンプレートとストレージ連携の検討。
- Supabase Storage を活用した原本ファイル保管。
- 追加ロール（監査ユーザー等）のアクセス要件整理。
