# MVP追加機能 仕様書（Requirements）

## 目的
いろはなとのギャップ分析で抽出した高優先度機能（タスクボード、届出フロー進捗管理、証憑アップロード）を ssw_saas の MVP に追加し、特定技能業務の運用性と法令順守リスクを低減する。

## スコープ
- 対象機能：
  1. 期限ドリブンタスクボード
  2. 届出フロー進捗トラッカー（定期届出／在留期間更新）
  3. 証憑アップロード管理（最小構成）
- 対象ユーザー：受入機関の管理者、登録支援機関スタッフ
- 対象環境：既存の Vite + React + Supabase（PostgreSQL / Storage）のみを利用し、追加でサーバーレス関数や外部サービスは導入しない。

## 機能要件
### 1. 期限ドリブンタスクボード
- ダッシュボード上に以下のカードを表示し、締切と進行度を提示する。
  - 定期届出：直近の提出期限、対象四半期、現ステータス
  - 在留期間更新：最遅在留期限、申請予定日、対象者数
  - 退職予定者：予定退職日、対象人数
- 残日数に応じてカードのアクセントカラーを変化させる（7日以内=警告、3日以内=危険）。
- クリック時に該当画面へ遷移できる（フォームまたは一覧にフォーカス）。
- データはダッシュボード表示時に Supabase から直接取得し、再読み込み時に更新される（バックグラウンド処理は行わない）。

### 2. 届出フロー進捗トラッカー
- 定期届出・在留期間更新フォーム上部にステップ表示を追加し、進捗率を可視化。
- 各ステップの完了条件：
  - フォーム入力完了（必須項目がバリデーションを通過）
  - 必須証憑のアップロード完了
  - 送信準備チェック（確認チェックボックスなど）
- ステップが完了すると状態を保存し、再訪時に表示を復元。
- ステップが全て完了するとタスクボードの該当カードが「完了待ち」に遷移。

### 3. 証憑アップロード管理
- 各対象フローに以下の証憑アップロード枠を追加：
  - 定期届出：賃金台帳（PDF/Excel）、面談記録（PDF）
  - 在留更新：在留カード写し（PDF/画像）、雇用契約書（PDF）
- 1証憑につき1ファイル、最大10MB。再アップロード時は上書き。
- アップロード済みファイルの閲覧（ダウンロード）と削除が可能。
- アップロード情報（ファイル名、タイプ、アップロード者、日時）を表示。
- 未アップロードの場合はステップ完了不可とする。

## 非機能要件
- Supabase Storage の RLS により `company_id` 単位でアクセス制限を実施。
- 追加するデータベース変更は極力シンプルに保ち、必要最小限のカラム追加・テーブル追加で対応する（複雑なストアドやトリガーは作成しない）。
- UI は既存の shadcn/ui トーンに合わせ、アクセシビリティ基準（WCAG 2.1 AA）を満たす。
- アップロードファイルは 180 日後に自動削除しない（長期保管）。削除はユーザー操作のみ。

## 成功指標 (最低限)
- ダッシュボード上のタスクカードが 0 件状態でも表示崩れがない。
- 進捗トラッカーで完了状態が保存・復元され、再訪時も正しいステップが表示される。
- 証憑アップロード後、他テナントからのアクセスが拒否される。

## 依存関係・前提
- 現行 `documents` テーブルおよびフロントエンドのフォーム実装が最新版であること。
- Supabase プロジェクトで Storage 機能が利用可能であること。
- 期限情報は既存テーブルから直接取得し、フロントエンドで簡易的に集計・計算できること。

## リスクと対策
- **Storage アクセス権限の誤設定** → RLS ルールをテストし、QA で他社テナントアクセスを試行。
- **ステップ完了判定の複雑化** → 完了条件を共有仕様書に明文化し、ユニットテストで条件を検証。
- **タスクカードの情報過多** → MVPでは3カードに限定し、追加項目はFuture扱いとする。
