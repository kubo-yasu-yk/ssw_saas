# MVP追加機能要件（いろはなギャップ対応）

本ドキュメントは `docs/irohana/function-gap-analysis.md` の差分分析を受け、現行 ssw_saas の MVP スコープに組み込むべき高優先度の追加機能要件をまとめたものです。対象は、期限遵守と法令対応の運用負荷を下げる3つの機能です。

## 1. 期限ドリブンタスクボード

### 目的
- 定期届出や在留期間更新など締切を伴う業務の漏れを防ぎ、担当者が優先順位を即座に把握できるようにする。

### 対象ユーザー / シナリオ
- 管理者・登録支援機関スタッフがログイン後に当日の作業や逼迫タスクを確認する。

### 要件
- 初期リリースでは以下のタスクカードを表示する：
  - 定期届出（最も近い提出期限、対象四半期、現ステータス）
  - 在留期間更新（最新版の期限、対象人数、最遅期限）
  - 退職予定者（予定日、対象人数）
- カードごとに「期限日」「現在ステータス」「担当者（存在する場合）」を表示。
- ステータスは既存ドキュメント状態（ドラフト／申請中／承認済みなど）と連動し、タスクカード側では「未着手」「進行中」「要確認」にマッピング。
- 締切までの残日数に応じてラベル色を変更（例：7日以内=警告、3日以内=危険）。
- 各カードから該当ページ（定期届出／在留更新／退職処理）へ遷移できる CTA を設置。

### 非対象
- 任意のタスクカスタマイズ・担当者アサイン UI・通知機能（将来拡張で検討）。

### 技術メモ
- 既存 Supabase テーブルからの期限情報算出関数を作成し、`AppStateContext` 内で集約。
- フロントエンドはダッシュボードページにカードコンポーネントを追加。tailwind + shadcn/ui のカードで実装。

## 2. 届出フロー進捗トラッカー

### 目的
- 定期届出・在留更新などのマルチステップ業務の進行状況を明示し、必要ステップの抜け漏れを防ぐ。

### 対象フロー（MVP）
1. 定期届出（受入・活動状況／支援実施状況）
2. 在留期間更新

### 要件
- 各フローにステップ定義を追加し、ページ上部で進捗バー／ステップリストを表示。
  - 例：定期届出 = 「届出フォーム入力」→「賃金台帳アップロード」→「電子申請準備」
  - 在留更新 = 「申請情報入力」→「証憑確認」→「申請送信」
- ステップは完了条件（必須フィールド入力済み、アップロード済み等）を満たしたときに完了状態に更新。
- 進捗は Supabase 上の新規フィールド（例：`submission_steps` JSON）に保存し、再訪時に復元。
- ステップ完了後に編集不可とする項目がある場合は警告ダイアログを表示。
- 進捗が100%になるとタスクボードの該当カードが「要確認」から「完了待ち」に遷移。

### 非対象
- 本番電子申請 API 連携、提出履歴一覧ページ（将来対応）。

### 技術メモ
- Supabase `documents` テーブルにステップ状態を保持する JSONB フィールドを追加。
- UI は shadcn/ui の Steps コンポーネント、または Radix の Tabs + Progress を利用して実装。

## 3. 証憑アップロード管理（最小構成）

### 目的
- 法令で提出が求められる証憑（例：賃金台帳、支援記録等）をシステム内で保管し、各フローの完了条件として扱う。

### 対象証憑（MVP）
- 定期届出：賃金台帳 PDF/Excel、面談記録 PDF
- 在留更新：在留カード写し、雇用契約書 PDF

### 要件
- 各フローに証憑アップロードセクションを追加し、指定ファイル種別（PDF/Excel）と最大サイズ（例：10MB）を強制。
- Supabase Storage を利用し、`company_id` ベースでアクセスを制限。ファイルメタ情報（種別、アップロード日、アップロード者）を `documents` もしくは新規 `attachments` テーブルに保存。
- アップロード状態がステップ完了条件と連動し、未アップロードの場合は進捗トラッカーが完了にならない。
- 再アップロード時は旧ファイルを置き換え、履歴は保持しない（MVP）。
- ダウンロードリンクと削除ボタンを用意（削除時は進捗を未完了に戻す）。

### 非対象
- ファイルバージョン履歴、ウイルススキャン、マルチファイル添付（各種別1ファイルのみとする）。

### 技術メモ
- Supabase Storage バケットを `documents-evidence`（仮）として新設し、RLS で `company_id` ごとのアクセス制御。
- フロント側では `@supabase/supabase-js` の Storage API を利用。フォーム送信時にファイルキーを保存。

## 今後検討すべき関連機能（MVP範囲外）
- CSV インポート／エクスポートと一括申請作成。
- 制度情報のお知らせ配信・通知センター。
- より詳細なライフサイクル（内定→在籍→退職）ビューとガントチャート型の可視化。

